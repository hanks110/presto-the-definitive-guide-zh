# 4. Presto 技术架构

在前面的章节介绍了 Presto 以及进行了初始安装和使用之后，我们现在讨论 Presto 架构。 我们将深入探讨相关概念，因此您可以了解 Presto 查询执行模型，查询计划和基于代价的优化器。

在本章中，我们首先讨论 Presto 高级架构组件。大致了解 Presto 的工作方式非常重要，特别是如果您打算自己安装和管理 Presto 集群，如第5章所述。

在本章的下半部分，当我们讨论 Presto 的查询执行模型时，我们将更深入地研究这些组件。 如果您需要诊断或调优性能低下的查询（在第8章中进行了讨论），或者您打算为 Presto 开源项目做出贡献，那么这是非常重要的。

## 集群中的 Coordinator 和 Worker

如第2章中所述，首次安装 Presto 时，仅使用一台计算机来运行。这种部署方式无法满足可伸缩性和性能的要求。

Presto 是一个分布式 SQL 查询引擎，类似于大规模并行处理（MPP）的数据库和查询引擎。它无需依赖于运行 Presto 的服务器的垂直扩展，而是能够以水平方式在服务器集群中分布所有处理。这意味着用户可以添加更多节点以获得更多处理能力。

利用这种体系结构，Presto 查询引擎能够跨集群或节点并行处理大数据量的 SQL 查询。 Presto 在每个节点上作为单服务进程运行。运行 Presto 的多个节点（配置为彼此协作）组成一个 Presto 集群。

图4-1描述了由一个协调节点和多个工作节点组成的 Presto 群集。 Presto 用户通过客户端连接到协调节点，例如使用 JDBC 驱动程序或 Presto CLI 工具。然后，协调节点与工作节点协作，工作节点访问数据源。

![&#x56FE; 4-1](../.gitbook/assets/image%20%284%29.png)

协调节点（coordinator）负责接收所有的查询，并且管理工作节点去执行查询。

工作节点（worker）负责执行任务并且处理数据。

发现服务（discovery service）通常运行在协调节点上，允许工作节点注册并参与到集群中。

所有节点、客户端之间的通信使用了基于 HTTP/HTTPS 的 REST 协议。

图 4-2 展示了节点间是如何通信的。协调节点与工作节点通信，以分配任务，更新状态，获取最外层的结果返回给用户。工作节点之间也会互相通信，以获取来自其他节点的上游任务的数据。所有的节点都可以从数据源抽取数据。

![&#x56FE; 4-2](../.gitbook/assets/image%20%287%29.png)

## Coordinator 协调节点

协调节点负责接收用户的 SQL 查询请求，解析语法，构建执行计划，管理工作节点。它可以说是 Presto 的大脑。用户可以通过 Presto 命令行工具访问；应用程序可以通过 JDBC/ODBC 驱动访问；其他语言编写的程序也可以通过不同的客户端工具访问。协调节点从客户端接收 SQL 语句，比如 `select`。

Presto 运行环境必须包含一个协调节点，以及一个或多个工作节点。在开发及测试环境，这两个角色可以部署在一台机器上。

协调节点持续追踪工作节点的状态，以及捕获查询的执行情况。协调节点创建了一个多阶段的执行模型。

图 4-3 展示了客户端、协调节点、工作节点之间的通信。

一旦接收到 SQL 语句，协调节点就会开始解析、分析、计划，并在工作节点之间分发调度。查询语句会被翻译为一系列运行在整个集群的、相互关联的任务。工作节点处理完成数据后，协调节点将会通过输出缓冲区将数据返回给客户端。一旦客户端完全读取输出缓冲，协调节点就会代表客户端向工作节点请求更多数据。 另外，工作节点与数据源进行交互以从中获取数据。最终，客户端不断请求数据并由工作节点从数据源提供数据，直到查询执行完成。

协调节点和工作节点使用 HTTP 协议通信。



![&#x56FE; 4-3](../.gitbook/assets/image%20%281%29.png)

## Discovery Service 发现服务

Presto 使用了发现服务来找到集群中所有的节点。每个 Presto 实例在启动时都会向发现服务注册，并定期发送心跳信号。这允许协调节点拥有可用工作节点的最新列表，并将该列表用于计划查询执行。

如果工作节点无法报告心跳信号，则发现服务将触发故障检测，并且该工作节点将无法再执行其他任务。

为了简化部署并避免运行其他服务，Presto 的发现服务通常是嵌入部署在协调节点。 它与 Presto 共享 HTTP 服务，因此使用相同的端口。

因此，发现服务的工作程序配置通常指向协调节点的主机名和端口。

## Worker 工作节点

Presto 工作节点是 Presto 集群中的服务者。 它负责执行协调器分配的任务并处理数据。工作节点通过使用连接器从数据源获取数据，然后彼此交换中间数据。 最终得到的数据将传递给协调节点。协调节点负责从工作节点那里收集结果并将最终结果提供给客户端。

在安装过程中，工作节点被配置为需要知道集群发现服务的主机名或IP地址。当工作节点的进程启动时，它会向发现服务发布信息，这将使协调程序可以使用它来执行任务。

工作节点使用基于 HTTP 的协议与其他工作节点和协调节点进行通信。

图 4-4 展示了工作节点是如何获取数据，以及相互之间如何协作处理数据，直到将数据传递给协调节点才停止。

![&#x56FE; 4-4](../.gitbook/assets/image%20%289%29.png)

## 基于 Connector 的架构



## Catalogs，Schemas 和 Tables

## 查询执行模型

## 查询计划

## 优化规则

## 执行规则

## 基于代价的优化器

## 处理表分析

## 总结



